@model ITSL_Administration.Models.Submission
@{
    ViewData["Title"] = "Submission Details - ITSL Administration";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var isStaff = User.IsInRole("Admin") || User.IsInRole("Lecturer") || User.IsInRole("Tutor");
    var isParticipant = User.Identity?.Name == Model.Participant?.Email;
    var canView = isStaff || isParticipant;
}

@section Breadcrumbs {
    <li class="breadcrumb-item">
        <a asp-controller="Courses" asp-action="Index" class="text-link">Courses</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Assignment" asp-action="ManageAssignment" asp-route-courseId="@Model.Assignment?.CourseId" class="text-link">Assignments</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Assignment" asp-action="Details" asp-route-id="@Model.AssignmentId" class="text-link">@Model.Assignment?.Title</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Assignment" asp-action="ManageSubmissions" asp-route-id="@Model.AssignmentId" class="text-link">Submissions</a>
    </li>
    <li class="breadcrumb-item active">Submission Details</li>
}

<div class="container-fluid mt-4">
    <!-- Page Header -->
    <div class="index-header">
        <div>
            <h1 class="display-6 text-primary-blue mb-1">
                <i class="fas fa-file-alt me-2"></i>Submission Details
            </h1>
            <p class="text-muted mb-0">
                @Model.Assignment?.Title - @Model.Assignment?.Course?.CourseName
            </p>
        </div>
        <div class="btn-group">
            <a asp-controller="Assignment" asp-action="ManageSubmissions" asp-route-id="@Model.AssignmentId"
               class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Back to Submissions
            </a>
            @if (isStaff)
            {
                <form asp-action="Delete" method="post" class="d-inline">
                    <input type="hidden" name="id" value="@Model.SubmissionID" />
                    <button type="submit" class="btn btn-outline-danger"
                            onclick="return confirm('Are you sure you want to delete this submission? All associated files will be permanently removed.')">
                        <i class="fas fa-trash me-2"></i>Delete Submission
                    </button>
                </form>
            }
        </div>
    </div>

    <!-- Success Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!canView)
    {
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            You do not have permission to view this submission.
        </div>
    }
    else
    {
        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                <!-- Submission Information -->
                <div class="form-card mb-4">
                    <h4 class="form-header">
                        <i class="fas fa-info-circle me-2"></i>Submission Information
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="details-list">
                                <dt>Submitted By:</dt>
                                <dd class="fw-bold">@Model.Participant?.FullName</dd>

                                <dt>Email:</dt>
                                <dd>@Model.Participant?.Email</dd>

                                <dt>Student ID:</dt>
                                <dd>@Model.ParticipantId</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="details-list">
                                <dt>Submission Date:</dt>
                                <dd>@Model.DateSubmitted.ToString("dd MMM yyyy 'at' HH:mm")</dd>

                                <dt>Assignment Due:</dt>
                                <dd class="@(Model.DateSubmitted > Model.Assignment?.DueDate ? "text-danger fw-bold" : "")">
                                    @Model.Assignment?.DueDate.ToString("dd MMM yyyy 'at' HH:mm")
                                    @if (Model.DateSubmitted > Model.Assignment?.DueDate)
                                    {
                                        <span class="badge bg-danger ms-2">Late Submission</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success ms-2">On Time</span>
                                    }
                                </dd>

                                <dt>Days Late:</dt>
                                <dd>
                                    @if (Model.DateSubmitted > Model.Assignment?.DueDate)
                                    {
                                        var daysLate = (Model.DateSubmitted - Model.Assignment.DueDate).Days;
                                        <span class="text-danger">@daysLate day(s)</span>
                                    }
                                    else
                                    {
                                        <span class="text-success">0 days</span>
                                    }
                                </dd>
                            </dl>
                        </div>
                    </div>
                </div>

                <!-- Submitted Files -->
                <div class="form-card mb-4">
                    <h4 class="form-header">
                        <i class="fas fa-paperclip me-2"></i>Submitted Files
                        <span class="badge bg-primary ms-2">@Model.Files.Count</span>
                    </h4>
                    @if (Model.Files.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped index-table">
                                <thead>
                                    <tr>
                                        <th>File Name</th>
                                        <th>Type</th>
                                        <th>Size</th>
                                        <th>Uploaded</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var file in Model.Files)
                                    {
                                        <tr>
                                            <td>
                                                <i class="fas fa-file me-2 text-primary-blue"></i>
                                                <span class="fw-bold">@file.FileName</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">@System.IO.Path.GetExtension(file.FileName).ToUpper()</span>
                                            </td>
                                            <td>@(file.FileSize / 1024) KB</td>
                                            <td>@file.UploadDate.ToString("dd MMM yyyy")</td>
                                            <td class="text-end action-buttons">
                                                <a href="@Url.Action("Download", "File", new { id = file.FileId })"
                                                   class="btn btn-sm btn-outline-primary"
                                                   target="_blank"
                                                   title="Download @file.FileName">
                                                    <i class="fas fa-download"></i> Download
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <i class="fas fa-file-export fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No Files Submitted</h5>
                            <p class="text-muted">No files were uploaded with this submission.</p>
                        </div>
                    }
                </div>

                <!-- Assignment Details -->
                <div class="form-card">
                    <h4 class="form-header">
                        <i class="fas fa-clipboard-list me-2"></i>Assignment Details
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="details-list">
                                <dt>Assignment Title:</dt>
                                <dd class="fw-bold">@Model.Assignment?.Title</dd>

                                <dt>Course:</dt>
                                <dd>@Model.Assignment?.Course?.CourseName</dd>

                                <dt>Course Code:</dt>
                                <dd>@Model.Assignment?.Course?.CourseCode</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="details-list">
                                <dt>Assignment Type:</dt>
                                <dd>
                                    <span class="badge @(Model.Assignment?.AssignmentType.ToString() == "Quiz" ? "bg-info" : "bg-primary")">
                                        @Model.Assignment?.AssignmentType
                                    </span>
                                </dd>

                                <dt>Total Marks:</dt>
                                <dd>@Model.Assignment?.SetAssignmentMark</dd>

                                <dt>Weight:</dt>
                                <dd>
                                    <span class="badge bg-secondary">@(Model.Assignment?.Weight.ToString("P0"))</span>
                                </dd>
                            </dl>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Assignment?.Description))
                    {
                        <div class="mt-3">
                            <dt class="text-muted mb-2">Assignment Description:</dt>
                            <dd class="p-3 bg-light rounded">@Model.Assignment.Description</dd>
                        </div>
                    }
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Grade Information -->
                @if (Model.Grade != null)
                {
                    <div class="form-card mb-4">
                        <h4 class="form-header">
                            <i class="fas fa-graduation-cap me-2"></i>Grade Information
                        </h4>
                        <div class="text-center mb-3">
                            <div class="display-4 fw-bold @(Model.Grade.HasPassed ? "text-success" : "text-danger")">
                                @Model.Grade.AssignmentMark.ToString("F1")/@Model.Assignment?.SetAssignmentMark
                            </div>
                            <div class="h5 text-muted mb-2">
                                @((Model.Grade.AssignmentMark / Model.Assignment.SetAssignmentMark * 100).ToString("F1"))%
                            </div>
                            <span class="badge @(Model.Grade.HasPassed ? "bg-success" : "bg-danger") fs-6">
                                @(Model.Grade.HasPassed ? "PASS" : "FAIL")
                            </span>
                        </div>

                        <dl class="details-list">
                            <dt>Final Course Mark:</dt>
                            <dd class="fw-bold">@Model.Grade.FinalMark.ToString("F1")%</dd>

                            <dt>Graded By:</dt>
                            <dd>@Model.Grade.MarkedBy</dd>

                            <dt>Date Graded:</dt>
                            <dd>@Model.Grade.DateRecorded.ToString("dd MMM yyyy 'at' HH:mm")</dd>
                        </dl>

                        <div class="mt-3">
                            <a asp-controller="Grades" asp-action="Details" asp-route-id="@Model.Grade.GradeID"
                               class="btn btn-outline-primary btn-block">
                                <i class="fas fa-eye me-2"></i>View Grade Details
                            </a>
                        </div>
                    </div>

                    <!-- Feedback -->
                    @if (!string.IsNullOrEmpty(Model.Grade.GradesFeedback))
                    {
                        <div class="form-card mb-4">
                            <h4 class="form-header">
                                <i class="fas fa-comments me-2"></i>Feedback
                            </h4>
                            <div class="bg-light p-3 rounded">
                                <p class="mb-0 text-break">@Model.Grade.GradesFeedback</p>
                            </div>
                            <div class="mt-2 text-muted text-end">
                                <small>@Model.Grade.GradesFeedback.Length/500 characters</small>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="form-card mb-4">
                        <h4 class="form-header">
                            <i class="fas fa-clock me-2"></i>Grading Status
                        </h4>
                        <div class="text-center py-4">
                            <i class="fas fa-hourglass-half fa-3x text-warning mb-3"></i>
                            <h5 class="text-warning">Awaiting Grading</h5>
                            <p class="text-muted">This submission has not been graded yet.</p>
                            @if (isStaff)
                            {
                                <a asp-controller="Grades" asp-action="Create" asp-route-submissionId="@Model.SubmissionID"
                                   class="btn btn-primary mt-2">
                                    <i class="fas fa-pen me-2"></i>Grade Submission
                                </a>
                            }
                        </div>
                    </div>
                }

                <!-- Quick Actions -->
                <div class="form-card">
                    <h4 class="form-header">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h4>
                    <div class="d-grid gap-2">
                        <a asp-controller="Assignment" asp-action="Details" asp-route-id="@Model.AssignmentId"
                           class="btn btn-outline-primary text-start">
                            <i class="fas fa-eye me-2"></i>View Assignment
                        </a>

                        @if (isStaff)
                        {
                            <a asp-controller="Assignment" asp-action="ManageSubmissions" asp-route-id="@Model.AssignmentId"
                               class="btn btn-outline-success text-start">
                                <i class="fas fa-list me-2"></i>All Submissions
                            </a>

                            if (Model.Grade != null)
                            {
                                <a asp-controller="Grades" asp-action="Edit" asp-route-id="@Model.Grade.GradeID"
                                   class="btn btn-outline-warning text-start">
                                    <i class="fas fa-edit me-2"></i>Edit Grade
                                </a>
                            }
                            else
                            {
                                <a asp-controller="Grades" asp-action="Create" asp-route-submissionId="@Model.SubmissionID"
                                   class="btn btn-outline-success text-start">
                                    <i class="fas fa-pen me-2"></i>Grade Submission
                                </a>
                            }
                        }

                        @if (isParticipant)
                        {
                            <a asp-controller="Grades" asp-action="ParticipantGrades"
                               class="btn btn-outline-info text-start">
                                <i class="fas fa-graduation-cap me-2"></i>My Grades
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Add confirmation for delete action
            const deleteForm = document.querySelector('form[asp-action="Delete"]');
            if (deleteForm) {
                deleteForm.addEventListener('submit', function(e) {
                    if (!confirm('Are you sure you want to delete this submission? All associated files and grades will be permanently removed.')) {
                        e.preventDefault();
                    }
                });
            }

            // Add file download tracking
            const downloadLinks = document.querySelectorAll('a[href*="/File/Download/"]');
            downloadLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const fileName = this.getAttribute('title')?.replace('Download ', '') || 'unknown';
                    console.log(`File downloaded: ${fileName}`);
                });
            });
        });
    </script>
}