@{
    ViewData["Title"] = "Submit Assignment - ITSL Administration";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var dueDate = ViewBag.DueDate as DateTime?;
    var isPastDue = dueDate.HasValue && dueDate.Value < DateTime.Now;
}

@section Breadcrumbs {
    <li class="breadcrumb-item">
        <a asp-controller="Courses" asp-action="Index">Courses</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Assignments" asp-action="ManageAssignment" asp-route-courseId="@ViewBag.CourseId">Assignments</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Assignments" asp-action="Details" asp-route-id="@ViewBag.AssignmentId">@ViewBag.AssignmentTitle</a>
    </li>
    <li class="breadcrumb-item active">Submit Assignment</li>
}

<div class="container mt-4">
    <div class="card shadow-sm">
        <div class="card-header @(isPastDue ? "bg-warning text-dark" : "bg-primary-blue text-white") d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-upload me-2"></i>Submit Assignment
            </h4>
            @if (isPastDue)
            {
                <span class="badge bg-danger fs-6">
                    <i class="fas fa-exclamation-triangle me-1"></i>PAST DUE
                </span>
            }
        </div>

        <div class="card-body">
            <!-- Assignment Information -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-light-blue">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Assignment Information</h5>
                        </div>
                        <div class="card-body">
                            <h5 class="text-primary-blue">@ViewBag.AssignmentTitle</h5>
                            <p class="mb-2"><strong>Course:</strong> @ViewBag.CourseName</p>
                            <p class="mb-2 @(isPastDue ? "text-danger fw-bold" : "")">
                                <strong>Due Date:</strong> @dueDate.Value.ToString("dd MMM yyyy 'at' HH:mm")
                            </p>
                            @if (isPastDue)
                            {
                                <div class="alert alert-danger mt-3">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>This assignment is overdue!</strong> Late submissions may be subject to penalties.
                                </div>
                            }
                            else if (dueDate.Value.AddDays(1) > DateTime.Now)
                            {
                                <div class="alert alert-warning mt-3">
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>Due soon!</strong> Submit your work before the deadline.
                                </div>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header bg-light-blue">
                            <h6 class="mb-0"><i class="fas fa-guidelines me-2"></i>Submission Guidelines</h6>
                        </div>
                        <div class="card-body">
                            <ul class="small mb-0">
                                <li>You can upload multiple files</li>
                                <li>Maximum file size: 50MB per file</li>
                                <li>Supported formats: PDF, Word, Excel, Images, Archives</li>
                                <li>Ensure files are correctly named</li>
                                <li>You can resubmit before the deadline</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <form asp-action="Create" asp-route-assignmentId="@ViewBag.AssignmentId" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="card mb-4">
                    <div class="card-header bg-light-blue">
                        <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Files</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="files" class="form-label fw-bold">Select Files *</label>
                            <input type="file" name="files" id="files" multiple class="form-control" required
                                   accept=".pdf,.doc,.docx,.txt,.zip,.rar,.jpg,.jpeg,.png,.xls,.xlsx,.ppt,.pptx" />
                            <div class="form-text">
                                Hold Ctrl (Windows) or Command (Mac) to select multiple files. Maximum 50MB per file.
                            </div>
                        </div>

                        <!-- File Preview Area -->
                        <div id="filePreview" class="mt-3" style="display: none;">
                            <h6 class="text-primary-blue">Selected Files:</h6>
                            <div id="fileList" class="list-group"></div>
                        </div>
                    </div>
                </div>

                <!-- Important Notice -->
                <div class="alert alert-warning">
                    <h6 class="alert-heading"><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h6>
                    <p class="mb-0">
                        Once submitted, your files will be uploaded and cannot be modified.
                        Please verify all files are correct before submitting. You can submit a new version before the deadline if needed.
                    </p>
                </div>

                <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top">
                    <a asp-action="Details" asp-controller="Assignment" asp-route-id="@ViewBag.AssignmentId"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Assignment
                    </a>
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-paper-plane me-2"></i>Submit Assignment
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('files');
            const filePreview = document.getElementById('filePreview');
            const fileList = document.getElementById('fileList');

            fileInput.addEventListener('change', function() {
                fileList.innerHTML = '';

                if (this.files.length > 0) {
                    filePreview.style.display = 'block';

                    for (let file of this.files) {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        fileItem.innerHTML = `
                            <div>
                                <i class="fas fa-file text-primary-blue me-2"></i>
                                <span>${file.name}</span>
                                <small class="text-muted ms-2">(${(file.size / 1024 / 1024).toFixed(2)} MB)</small>
                            </div>
                        `;
                        fileList.appendChild(fileItem);
                    }
                } else {
                    filePreview.style.display = 'none';
                }
            });

            // File size validation
            fileInput.addEventListener('change', function() {
                const maxSize = 50 * 1024 * 1024; // 50MB
                for (let file of this.files) {
                    if (file.size > maxSize) {
                        alert(`File "${file.name}" exceeds the 50MB size limit. Please choose a smaller file.`);
                        this.value = '';
                        filePreview.style.display = 'none';
                        break;
                    }
                }
            });
        });
    </script>
}