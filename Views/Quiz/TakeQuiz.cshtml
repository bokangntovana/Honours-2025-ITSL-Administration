@model ITSL_Administration.ViewModels.QuizViewModel

@{
    ViewData["Title"] = "Take Quiz";
}

<div class="container mt-4">
    <h2 class="mb-3">@Model.QuizTitle</h2>
    <p class="text-muted">Course: @Model.CourseName | Due: @Model.DueDate.ToString("d")</p>
    
    <!-- Progress Indicator -->
    <div class="progress mb-4" style="height: 20px;">
        <div class="progress-bar" role="progressbar" 
             style="width: @((Model.CurrentPage * 100) / Model.TotalPages)%"
             aria-valuenow="@Model.CurrentPage" 
             aria-valuemin="1" 
             aria-valuemax="@Model.TotalPages">
            Page @Model.CurrentPage of @Model.TotalPages
        </div>
    </div>

    <form asp-action="TakeQuiz" asp-controller="Quiz" method="get">
        <input type="hidden" name="quizId" value="@Model.QuizId" />
        
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between mb-4">
            @if (Model.HasPreviousPage)
            {
                <button type="submit" name="page" value="@Model.PreviousPage" 
                        class="btn btn-outline-primary">
                    ← Previous Page
                </button>
            }
            else
            {
                <span></span> <!-- Spacer for alignment -->
            }
            
            <span class="align-self-center">Page @Model.CurrentPage of @Model.TotalPages</span>
            
            @if (Model.HasNextPage)
            {
                <button type="submit" name="page" value="@Model.NextPage" 
                        class="btn btn-outline-primary">
                    Next Page →
                </button>
            }
            else
            {
                <button type="button" class="btn btn-success" 
                        onclick="document.getElementById('submitQuiz').click()">
                    Submit Quiz
                </button>
            }
        </div>
    </form>

    <form asp-action="SubmitQuiz" asp-controller="Quiz" method="post" id="quizForm">
        <input type="hidden" asp-for="QuizId" />
        <input type="hidden" asp-for="AssignmentId" />
        <input type="hidden" asp-for="CurrentPage" />

        @for (int i = 0; i < Model.Questions.Count; i++)
        {
            var question = Model.Questions[i];
            <div class="card mb-3">
                <div class="card-header">
                    <strong>Question @(i + 1 + ((Model.CurrentPage - 1) * Model.PageSize))</strong>
                </div>
                <div class="card-body">
                    <p class="card-text">@question.QuestionText</p>

                    @* Hidden field to bind question id *@
                    <input type="hidden" name="Questions[@i].QuestionId" value="@question.QuestionId" />

                    @for (int j = 0; j < question.Options.Count; j++)
                    {
                        var option = question.Options[j];
                        var inputId = "option_" + question.QuestionId + "_" + j;
                        <div class="form-check">
                            <input type="radio"
                                   class="form-check-input"
                                   name="Questions[@i].UserAnswer"
                                   value="@option.Value" 
                                   id="@inputId" />
                            <label class="form-check-label" for="@inputId">
                                @option.Text
                            </label>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Hidden submit button for final submission; set name/value to bind to action parameter -->
        <button type="submit" id="submitQuiz" name="action" value="submit" class="d-none">Submit Quiz</button>
    </form>

    <!-- Bottom Pagination Controls -->
    <div class="mt-4">
        <form asp-action="TakeQuiz" asp-controller="Quiz" method="get">
            <input type="hidden" name="quizId" value="@Model.QuizId" />
            
            <div class="d-flex justify-content-between">
                @if (Model.HasPreviousPage)
                {
                    <button type="submit" name="page" value="@Model.PreviousPage" 
                            class="btn btn-outline-primary">
                        ← Previous Page
                    </button>
                }
                else
                {
                    <span></span>
                }
                
                @if (Model.HasNextPage)
                {
                    <button type="submit" name="page" value="@Model.NextPage" 
                            class="btn btn-outline-primary">
                        Next Page →
                    </button>
                }
                else
                {
                    <button type="button" class="btn btn-success" 
                            onclick="document.getElementById('submitQuiz').click()">
                        Submit Quiz
                    </button>
                }
            </div>
        </form>
    </div>
</div>

<!-- JavaScript to preserve answers when navigating between pages -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Load saved answers from sessionStorage
        const savedAnswers = JSON.parse(sessionStorage.getItem('quizAnswers_@Model.QuizId') || '{}');
        
        // Apply saved answers to radio buttons
        Object.keys(savedAnswers).forEach(questionId => {
            const selector = 'input[name="Questions[' + findQuestionIndex(questionId) + '].UserAnswer"][value="' + savedAnswers[questionId] + '"]';
            const radioButton = document.querySelector(selector);
            if (radioButton) {
                radioButton.checked = true;
            }
        });
        
        // Save answers when radio buttons change
        document.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', function() {
                // name example: Questions[0].UserAnswer
                const name = this.name;
                const m = name.match(/Questions\[(\d+)\]\.UserAnswer/);
                if (!m) return;
                const index = parseInt(m[1], 10);
                const questionIdInput = document.querySelector('input[name="Questions[' + index + '].QuestionId"]');
                if (!questionIdInput) return;
                const questionId = questionIdInput.value;
                const answer = this.value;

                let answers = JSON.parse(sessionStorage.getItem('quizAnswers_@Model.QuizId') || '{}');
                answers[questionId] = answer;
                sessionStorage.setItem('quizAnswers_@Model.QuizId', JSON.stringify(answers));
            });
        });

        // helper to find question index by id using rendered inputs
        function findQuestionIndex(questionId) {
            const inputs = document.querySelectorAll('input[name$=".QuestionId"]');
            for (let i = 0; i < inputs.length; i++) {
                if (inputs[i].value === questionId) return i;
            }
            return -1;
        }
    });
</script>