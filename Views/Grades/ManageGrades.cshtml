@model ITSL_Administration.Models.Course
@using ITSL_Administration.Models

@{
    ViewData["Title"] = "Grade Management - ITSL Administration";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var assignments = Model.Assignments.OrderBy(a => a.DueDate).ToList();

    var allParticipants = assignments
        .SelectMany(a => a.Submissions)
        .Select(s => s.Participant)
        .Where(p => p != null)
        .Distinct()
        .ToList();
}

@section Breadcrumbs {
    <li class="breadcrumb-item">
        <a asp-action="GradingOverview">Grading Overview</a>
    </li>
    <li class="breadcrumb-item active">@Model.CourseName</li>
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary-blue">
            <i class="fas fa-tasks me-2"></i>Grade Management - @Model.CourseName
        </h2>
        <a asp-action="ExportGradebookPdf" asp-route-courseId="@Model.CourseID" class="btn btn-primary">
            <i class="fas fa-download me-2"></i>Export Gradebook
        </a>
    </div>

    <!-- Course Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary-blue">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@allParticipants.Count</h4>
                            <p class="mb-0">Participants</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-users fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@assignments.Count</h4>
                            <p class="mb-0">Assignments</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clipboard-list fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@assignments.Sum(a => a.Submissions.Count(s => s.Grade == null))</h4>
                            <p class="mb-0">Ungraded</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>@assignments.Sum(a => a.Submissions.Count(s => s.Grade != null))</h4>
                            <p class="mb-0">Graded</p>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assignments Tabs -->
    <ul class="nav nav-tabs" id="assignmentsTab" role="tablist">
        @foreach (var assignment in assignments)
        {
            <li class="nav-item" role="presentation">
                <button class="nav-link @(assignment == assignments.First() ? "active" : "")"
                        id="tab-@assignment.AssignmentID"
                        data-bs-toggle="tab"
                        data-bs-target="#content-@assignment.AssignmentID"
                        type="button" role="tab">
                    @assignment.Title
                    <span class="badge
                                @(assignment.Submissions.Count(s => s.Grade == null) > 0 ? "bg-warning" : "bg-success")">
                        @assignment.Submissions.Count(s => s.Grade != null)/@assignment.Submissions.Count
                    </span>
                </button>
            </li>
        }
    </ul>

    <div class="tab-content" id="assignmentsTabContent">
        @foreach (var assignment in assignments)
        {
            <div class="tab-pane fade @(assignment == assignments.First() ? "show active" : "")"
                 id="content-@assignment.AssignmentID" role="tabpanel">

                <!-- Assignment Header -->
                <div class="card mt-3 shadow-sm">
                    <div class="card-header bg-light-blue">
                        <h5 class="mb-0">
                            @assignment.Title
                            <span class="badge
                                        @(assignment.AssignmentType.ToString() == "Quiz" ? "bg-info" :
                                          assignment.AssignmentType.ToString() == "WrittenAssignment" ? "bg-primary" : "bg-success") float-end">
                                @assignment.AssignmentType
                            </span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Due Date:</strong> @assignment.DueDate.ToString("dd MMM yyyy")</p>
                                <p><strong>Weight:</strong> <span class="badge bg-secondary">@((assignment.Weight * 100).ToString("F0"))%</span></p>
                                <p><strong>Total Marks:</strong> @assignment.SetAssignmentMark</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Submissions:</strong> @assignment.Submissions.Count</p>
                                <p><strong>Graded:</strong> @assignment.Submissions.Count(s => s.Grade != null)</p>
                                <p><strong>Pending:</strong> @assignment.Submissions.Count(s => s.Grade == null)</p>
                            </div>
                        </div>
                        @if (!string.IsNullOrEmpty(assignment.Description))
                        {
                            <p><strong>Description:</strong> @assignment.Description</p>
                        }
                    </div>
                </div>

                <!-- Submissions Table -->
                <div class="card mt-3 shadow-sm">
                    <div class="card-header bg-light-blue">
                        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Submissions</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Participant</th>
                                        <th>Submitted Date</th>
                                        <th>Status</th>
                                        <th>Mark</th>
                                        <th>Graded By</th>
                                        <th>Feedback</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var submission in assignment.Submissions.OrderBy(s => s.Participant?.FullName))
                                    {
                                        <tr>
                                            <td>
                                                <strong>@submission.Participant?.FullName</strong>
                                                <br />
                                                <small class="text-muted">@submission.Participant?.Email</small>
                                            </td>
                                            <td>@submission.DateSubmitted.ToString("dd MMM yyyy HH:mm")</td>
                                            <td>
                                                @if (submission.Grade == null)
                                                {
                                                    <span class="badge bg-warning">Not Graded</span>
                                                }
                                                else
                                                {
                                                    <span class="badge @(submission.Grade.HasPassed ? "bg-success" : "bg-danger")">
                                                        @(submission.Grade.HasPassed ? "Pass" : "Fail")
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                @if (submission.Grade != null)
                                                {
                                                    <strong>@submission.Grade.AssignmentMark.ToString("F1")/@assignment.SetAssignmentMark</strong>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>@submission.Grade?.MarkedBy</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(submission.Grade?.GradesFeedback))
                                                {
                                                    <button type="button" class="btn btn-sm btn-outline-info"
                                                            data-bs-toggle="tooltip"
                                                            title="@submission.Grade.GradesFeedback">
                                                        <i class="fas fa-comment"></i>
                                                    </button>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group btn-group-sm" role="group">
                                                    @if (submission.Grade == null)
                                                    {
                                                        <a asp-controller="Grades" asp-action="Create" asp-route-submissionId="@submission.SubmissionID"
                                                           class="btn btn-outline-success" title="Grade Submission">
                                                            <i class="fas fa-pen"></i>
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <a asp-controller="Grades" asp-action="Edit" asp-route-id="@submission.Grade.GradeID"
                                                           class="btn btn-outline-primary" title="Edit Grade">
                                                            <i class="fas fa-edit"></i>
                                                        </a>
                                                    }
                                                    <a asp-controller="Assignment" asp-action="ManageSubmissions" asp-route-id="@assignment.AssignmentID"
                                                       class="btn btn-outline-info" title="View Submissions">
                                                        <i class="fas fa-list"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Participants without submissions -->
                @{
                    var participantsWithSubmissionsForThisAssignment = assignment.Submissions.Select(s => s.ParticipantId).ToList();
                    var participantsWithoutSubmissionsForThisAssignment = allParticipants
                        .Where(p => !participantsWithSubmissionsForThisAssignment.Contains(p.Id))
                        .ToList();
                }

                @if (participantsWithoutSubmissionsForThisAssignment.Any())
                {
                    <div class="card mt-3 border-warning shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="fas fa-user-clock me-2"></i>Participants Without Submissions</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                @foreach (var participant in participantsWithoutSubmissionsForThisAssignment)
                                {
                                    <div class="col-md-4 mb-2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle text-muted me-2"></i>
                                            <div>
                                                <strong>@participant?.FullName</strong>
                                                <br />
                                                <small class="text-muted">@participant?.Email</small>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Auto-refresh page every 5 minutes to show latest submissions
        setTimeout(function() {
            location.reload();
        }, 300000); // 5 minutes
    </script>
}